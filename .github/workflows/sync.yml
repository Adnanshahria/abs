name: Sync to Mirror
on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  git-sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Push to AmarBallot (Excluding Workflows)
        env:
          SYNC_TOKEN: ${{ secrets.SYNC_TOKEN }}
          # Captures the exact commit message from the source push event
          COMMIT_MSG: ${{ github.event.head_commit.message }}
        run: |
          # 1. Configure git identity (Must be your lowercase Vercel email)
          git config --global user.email "your.vercel.email@example.com"
          git config --global user.name "Nisarr"
          
          # 2. Remove the workflows folder strictly from Git's tracking index
          git rm -rf --cached .github/workflows || true
          
          # 3. Commit the removal using the original commit message
          git commit -m "$COMMIT_MSG" || true
          
          # 4. Add the remote and force-push
          git remote add mirror https://x-access-token:${SYNC_TOKEN}@github.com/Nisarr/AmarBallot.git
          git push --force mirror HEAD:main
